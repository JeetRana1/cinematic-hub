<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player 2 — NontonGo Only</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .container{position:fixed;inset:0;display:flex;flex-direction:column}
    .topbar{height:56px;display:flex;align-items:center;gap:12px;padding:8px 12px;background:rgba(0,0,0,0.6);z-index:2147483647}
    .title{flex:1;font-weight:600}
    .btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:6px;color:#fff;cursor:pointer}
    .iframe-wrap{flex:1;position:relative;background:#000}
    iframe{position:absolute;border:0;inset:0;width:100%;height:100%;background:#000}
    .overlay{position:absolute;left:12px;right:12px;bottom:12px;padding:10px 14px;background:rgba(255,40,40,0.95);color:#fff;border-radius:8px;z-index:2147483647;display:none;font-weight:700}
    .hint{position:absolute;left:12px;top:68px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:6px;font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <button class="btn" id="backBtn">◀ Back</button>
      <div class="title">NontonGo Player (IMDB-based)</div>
      <button class="btn" id="retryBtn">Retry</button>
    </div>

    <div class="iframe-wrap" id="iframeWrap">
      <div class="hint" id="hint">Usage: ?imdb=tt1234567&type=movie or ?imdb=tt...&type=tv&season=1&episode=2</div>
      <div class="status" id="statusBanner">Proxy disabled — loading remote embed directly. <button id="openRemote" class="btn" style="margin-left:8px;">Open remote embed</button></div>
      <iframe id="playerIframe" src="about:blank" allow="autoplay; fullscreen; encrypted-media"></iframe>
      <div class="overlay" id="errorOverlay"></div>
      <div class="overlay" id="blockedOverlay" style="display:none; background:rgba(0,0,0,0.85);">
        <div id="blockedMsg" style="margin-bottom:8px; font-weight:700">Embed blocked in this frame.</div>
        <div style="display:flex;gap:8px"><button id="openBlocked" class="btn">Open embed in new tab</button><button id="dismissBlocked" class="btn">Dismiss</button></div>
      </div>
    </div>
  </div>

  <script>
    // Minimal NontonGo-only player (IMDB id). Builds embed URL and attempts to use an available proxy.

    function appendLog(msg, level){
      if(level==='warn') console.warn('[player2]', msg); else if(level==='error') console.error('[player2]', msg); else console.log('[player2]', msg);
    }

    // Prevent clear of console in this page (helps debugging across embed interactions)
    (function(){
      if (typeof console !== 'undefined' && typeof console.clear === 'function'){
        try {
          console._clearOriginal = console.clear.bind(console);
          console.clear = function(){ if (console && console.warn) console.warn('[player2] console.clear blocked'); };
        } catch(e) {}
      }
    })();

    function buildEmbedUrl(imdb, type, season, episode){
      imdb = String(imdb || '').trim();
      if(!imdb) return null;
      if(type === 'tv'){
        if(season && episode) return `https://www.NontonGo.win/embed/tv/${encodeURIComponent(imdb)}/${encodeURIComponent(season)}/${encodeURIComponent(episode)}`;
        return `https://www.NontonGo.win/embed/tv/?id=${encodeURIComponent(imdb)}&s=${encodeURIComponent(season||'')}&e=${encodeURIComponent(episode||'')}`;
      }
      return `https://www.NontonGo.win/embed/movie/${encodeURIComponent(imdb)}`;
    }

    // Proxy probing removed: this deployment uses direct embeds only.
    // The proxy server was intentionally deleted; we avoid probing local proxy candidates and
    // instead load the remote embed directly. If you later restore a proxy, reintroduce
    // findWorkingProxy with appropriate candidate list.
    async function findWorkingProxy(embedUrl){
      appendLog('Proxy probing disabled; skipping proxy discovery');
      return null;
    }

    function showError(msg){
      const el = document.getElementById('errorOverlay');
      el.textContent = msg;
      el.style.display = 'block';
      // keep error up for a bit longer for important notices
      setTimeout(()=> el.style.display = 'none', 8000);
    }

    function showStatus(msg){
      const s = document.getElementById('statusBanner');
      if(!s) return;
      s.innerHTML = msg + ' <button id="openRemote" class="btn" style="margin-left:8px;">Open remote embed</button>';
      const btn = document.getElementById('openRemote');
      if(btn) btn.addEventListener('click', () => { if(window._lastEmbedUrl) window.open(window._lastEmbedUrl, '_blank'); });
      s.style.display = 'block';
    }

    function showBlockedOverlay(msg, embedUrl){
      const ov = document.getElementById('blockedOverlay');
      const txt = document.getElementById('blockedMsg');
      if(txt) txt.textContent = msg || 'Embed blocked in this frame.';
      ov.style.display = 'block';
      const openBtn = document.getElementById('openBlocked');
      const dismissBtn = document.getElementById('dismissBlocked');
      openBtn.onclick = () => { window.open(embedUrl || window._lastEmbedUrl, '_blank'); };
      dismissBtn.onclick = () => { ov.style.display = 'none'; };
    }

    async function loadNontonGo(){
      try{
        const params = new URLSearchParams(window.location.search);
        const imdb = (params.get('imdb') || params.get('id') || '').trim();
        const type = (params.get('type') || 'movie').toLowerCase();
        const season = params.get('season');
        const episode = params.get('episode');

        if(!imdb){ showError('No IMDB id provided. Add ?imdb=tt1234567'); return; }

        const embedUrl = buildEmbedUrl(imdb, type, season, episode);
        if(!embedUrl){ showError('Invalid parameters'); return; }

        appendLog('Built embed URL: ' + embedUrl);

        // Proxy removed: load remote embed directly
        const iframe = document.getElementById('playerIframe');
        appendLog('Proxy disabled — loading remote embed directly');
        iframe.src = embedUrl;
        window._lastEmbedUrl = embedUrl;
        showStatus('Proxy disabled — loading remote embed (may require interaction)');
        // Attach a load/error handler to detect blocked/sandboxed embeds
        iframe.addEventListener('load', () => {
          appendLog('iframe load event fired');
          // small delay to allow remote page to render or navigate
          setTimeout(() => {
            try {
              // try to inspect the iframe document — if same-origin this will work
              const doc = iframe.contentDocument || iframe.contentWindow.document;
              const bodyText = (doc && doc.body) ? (doc.body.innerText || doc.body.textContent || '') : '';
              appendLog('iframe body length: ' + String((bodyText||'').length));
              if (/Sandboxed embed|Sandboxed embed is not allowed|sandboxed|not allowed/i.test(bodyText)){
                appendLog('Detected explicit sandbox-block text in iframe content', 'warn');
                showBlockedOverlay('This embed refuses to be embedded here. Open it in a new tab.');
              }
            } catch (e) {
              // cross-origin — we cannot inspect contents. However, we can check if browser logged a frame-refusal
              appendLog('iframe appears cross-origin or inaccessible: ' + (e && e.message ? e.message : e), 'warn');
              // Show a helpful overlay suggesting the user open the embed if it's blocked
              // We cannot reliably detect X-Frame-Options, so do a gentle non-blocking hint
              showStatus('Embed loaded (cross-origin). If it refuses to display, click "Open remote embed"');
            }
          }, 500);
        });
        iframe.addEventListener('error', () => {
          appendLog('iframe error event fired', 'error');
          showBlockedOverlay('Failed to load embed. Open it in a new tab to view.');
        });
        // Listen for postMessage events from embeds (if any)
        window.addEventListener('message', (ev) => {
          try {
            const data = ev && ev.data;
            if (!data || typeof data !== 'object') return;
            if (data.type === 'play_attempt') {
              appendLog('Embed requested autoplay (play_attempt)');
              showError('Embed started playback');
            }
            if (data.type === 'play_attempt_error'){
              appendLog('Embed reported play error: ' + (data.error || 'unknown'), 'warn');
              showError('Embed playback failed: ' + (data.error || 'unknown'));
            }
          } catch (e) {}
        });

      }catch(err){
        appendLog('loadNontonGo error: ' + (err && err.message ? err.message : err), 'error');
        showError('Failed to load embed');
      }
    }

    document.getElementById('retryBtn').addEventListener('click', () => {
      appendLog('Retry requested by user');
      loadNontonGo();
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      try {
        // Try to restore previous category and modal state
        const lastCategory = sessionStorage.getItem('currentModalCategory');
        const lastMovie = sessionStorage.getItem('currentModalMovie');
        window.location.href = `index.html${lastCategory ? ('?category=' + encodeURIComponent(lastCategory)) : ''}`;
        // After navigation, restore modal (using a short delay)
        if (lastMovie) {
          setTimeout(() => {
            try {
              const movie = JSON.parse(lastMovie);
              if (window.openMovieModal) window.openMovieModal(movie);
              else window.sessionStorage.setItem('restoreModal', lastMovie);
            } catch (e) {}
          }, 500);
        }
      } catch(e) { history.back(); }
    });

    // Auto-run on load
    window.addEventListener('DOMContentLoaded', () => {
      loadNontonGo();
    });
  </script>
</body>
</html>